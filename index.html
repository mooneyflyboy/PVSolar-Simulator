<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar Simulation Tool</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts: Roboto -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f8f9fa;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .form-range::-webkit-slider-thumb {
            background: #28a745;
        }
        .form-range::-moz-range-thumb {
            background: #28a745;
        }
        #solarSizeValue {
            margin-left: 10px;
            font-weight: 500;
        }
        .form-check {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <header class="text-center mb-4">
            <h1>Solar Simulation Tool</h1>
            <p class="lead">Explore how solar energy can impact your daily energy usage in the DFW area.</p>
        </header>

        <!-- Energy Usage Card -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Your Energy Usage</h5>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="bill" class="form-label">Monthly Electric Bill ($)</label>
                        <input type="number" class="form-control" id="bill" value="250" step="10" min="0">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="rate" class="form-label">Rate per kWh ($)</label>
                        <input type="number" class="form-control" id="rate" value="0.145" step="0.001" min="0">
                    </div>
                </div>
            </div>
        </div>

        <!-- Solar System Card -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Solar System</h5>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="solarSize" class="form-label">Solar System Size (KW)</label>
                        <div class="d-flex align-items-center">
                            <input type="range" class="form-range" id="solarSize" min="5" max="40" value="5" step="1">
                            <span id="solarSizeValue">5</span> KW
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="battery">
                            <label class="form-check-label" for="battery">Include Battery</label>
                        </div>
                    </div>
                </div>
                <div class="row d-none" id="batteryOptions">
                    <div class="col-md-6 mb-3">
                        <label for="batterySize" class="form-label">Battery Size (kWh)</label>
                        <input type="number" class="form-control" id="batterySize" value="10" step="1" min="0">
                    </div>
                </div>
            </div>
        </div>

        <!-- Load Distribution Card -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Load Distribution</h5>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input load-dist" type="checkbox" id="loadMorning" value="morning">
                            <label class="form-check-label" for="loadMorning">Morning</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input load-dist" type="checkbox" id="loadEvening" value="evening">
                            <label class="form-check-label" for="loadEvening">Evening</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input load-dist" type="checkbox" id="loadWorkFromHome" value="workFromHome">
                            <label class="form-check-label" for="loadWorkFromHome">Work from Home</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input load-dist" type="checkbox" id="loadFlat" value="flat" checked>
                            <label class="form-check-label" for="loadFlat">Flat</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Compensation Method Card -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Compensation Method</h5>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="compensation" class="form-label">Compensation Method</label>
                        <select class="form-select" id="compensation">
                            <option value="netMetering">Net Metering</option>
                            <option value="buyback">Buyback</option>
                            <option value="noCredit">No Credit</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3 d-none" id="buybackRateGroup">
                        <label for="buybackRate" class="form-label">Buyback Rate ($/kWh)</label>
                        <input type="number" class="form-control" id="buybackRate" step="0.001" min="0">
                    </div>
                </div>
            </div>
        </div>

        <!-- Month Card -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Month</h5>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="month" class="form-label">Select Month</label>
                        <select class="form-select" id="month">
                            <option value="1">January</option>
                            <option value="2">February</option>
                            <option value="3">March</option>
                            <option value="4">April</option>
                            <option value="5">May</option>
                            <option value="6">June</option>
                            <option value="7">July</option>
                            <option value="8">August</option>
                            <option value="9">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart Card -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Daily Energy Distribution</h5>
                <canvas id="energyChart"></canvas>
            </div>
        </div>

        <footer class="mt-4 text-center">
            <p>Â© 2025 Solar Simulation Tool | For DFW Area Residents</p>
        </footer>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Constants
        const peakSunHours = { 1: 4.0, 2: 4.5, 3: 5.0, 4: 5.5, 5: 6.0, 6: 6.5, 7: 6.5, 8: 6.0, 9: 5.5, 10: 5.0, 11: 4.5, 12: 4.0 };
        const solarFactors = [0,0,0,0,0,0, 0.2,0.4,0.6,0.8,0.9,1.0, 1.0,0.9,0.8,0.6,0.4,0.2, 0,0,0,0,0,0];
        const sumSolarFactors = solarFactors.reduce((a, b) => a + b, 0);
        const loadProfiles = {
            morning: [1,1,1,1,1,1, 3,3,3,3,3, 2,2,2,2,2,2, 2,2,2,2,2, 1,1],
            evening: [1,1,1,1,1,1, 2,2,2,2,2,2,2,2,2,2,2, 3,3,3,3,3, 1,1],
            workFromHome: [1,1,1,1,1,1, 2,2,2, 3,3,3,3,3,3,3,3,3, 2,2,2,2, 1,1],
            flat: [1,1,1,1,1,1, 1,1,1,1,1,1, 1,1,1,1,1,1, 1,1,1,1,1,1]
        };
        const sumLoadUnits = {
            morning: 45,
            evening: 45,
            workFromHome: 49,
            flat: 24
        };

        // Initialize Chart
        const ctx = document.getElementById('energyChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array.from({ length: 24 }, (_, i) => i),
                datasets: [
                    {
                        label: 'Solar Production',
                        data: [],
                        borderColor: 'green',
                        fill: false
                    },
                    {
                        label: 'Net Grid',
                        data: [],
                        borderColor: 'red',
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    x: { title: { display: true, text: 'Hour of Day' } },
                    y: { title: { display: true, text: 'Energy (kWh)' } }
                }
            }
        });

        // Calculate Hourly Values
        function calculateHourlyValues() {
            const bill = parseFloat(document.getElementById('bill').value) || 0;
            const rate = parseFloat(document.getElementById('rate').value) || 0;
            const solarSize = parseFloat(document.getElementById('solarSize').value);
            const loadDist = document.querySelector('.load-dist:checked')?.value || 'flat';
            const month = parseInt(document.getElementById('month').value);
            const hasBattery = document.getElementById('battery').checked;
            let batterySize = hasBattery ? parseFloat(document.getElementById('batterySize').value) || 0 : 0;

            // Error checking
            if (bill <= 0 || rate <= 0) {
                alert('Bill and rate must be positive.');
                return {
                    hourlyCons: Array(24).fill(0),
                    hourlySolar: Array(24).fill(0),
                    netGrid: Array(24).fill(0),
                    batteryDischarge: Array(24).fill(0)
                };
            }
            if (hasBattery && batterySize <= 0) {
                alert('Battery size must be positive.');
                return {
                    hourlyCons: Array(24).fill(0),
                    hourlySolar: Array(24).fill(0),
                    netGrid: Array(24).fill(0),
                    batteryDischarge: Array(24).fill(0)
                };
            }

            // Daily calculations
            const dailyCons = (bill / rate) / 30;
            const totalDailySolar = solarSize * peakSunHours[month];

            // Hourly profiles
            const hourlyCons = loadProfiles[loadDist].map(unit => (unit / sumLoadUnits[loadDist]) * dailyCons);
            const hourlySolar = solarFactors.map(factor => (factor / sumSolarFactors) * totalDailySolar);

            // Battery simulation
            let SOC = batterySize; // Start with full battery
            const P_bat = hasBattery ? batterySize / 2 : 0; // Max power (kW)
            const E_bat = batterySize; // Capacity (kWh)
            const dischargeHours = hasBattery ? (loadDist === 'morning' ? [6,7,8,9,10] : [17,18,19,20,21]) : [];
            const netGrid = [];
            const batteryDischarge = Array(24).fill(0);

            // First pass: Identify deficit hours
            const deficits = Array(24).fill(0);
            for (let h = 0; h < 24; h++) {
                const cons = hourlyCons[h];
                const solar = hourlySolar[h];
                if (solar < cons) {
                    deficits[h] = cons - solar;
                }
            }

            for (let h = 0; h < 24; h++) {
                const cons = hourlyCons[h];
                const solar = hourlySolar[h];

                if (solar >= cons) {
                    const excess = solar - cons;
                    if (hasBattery) {
                        const chargeAmount = Math.min(excess, P_bat, E_bat - SOC);
                        SOC += chargeAmount;
                        const remainingExcess = excess - chargeAmount;
                        netGrid.push(-remainingExcess);
                    } else {
                        netGrid.push(-excess);
                    }
                } else {
                    const deficit = cons - solar;
                    if (hasBattery && dischargeHours.includes(h) && deficits[h] > 0) {
                        const dischargeAmount = Math.min(deficit, P_bat, SOC);
                        SOC -= dischargeAmount;
                        batteryDischarge[h] = dischargeAmount;
                        netGrid.push(deficit - dischargeAmount);
                    } else {
                        netGrid.push(deficit);
                    }
                }
            }

            return { hourlyCons, hourlySolar, netGrid, batteryDischarge };
        }

        // Update Chart
        function updateChart() {
            const { hourlyCons, hourlySolar, netGrid, batteryDischarge } = calculateHourlyValues();
            const hasBattery = document.getElementById('battery').checked;

            // Base datasets
            const datasets = [
                {
                    label: 'Solar Production',
                    data: hourlySolar,
                    borderColor: 'green',
                    fill: false
                },
                {
                    label: 'Net Grid',
                    data: netGrid,
                    borderColor: 'red',
                    fill: false
                }
            ];

            // Add battery discharge dataset only if battery is enabled
            if (hasBattery) {
                datasets.push({
                    label: 'Battery Discharge',
                    data: batteryDischarge,
                    borderColor: 'purple',
                    fill: false
                });
            }

            // Update chart datasets
            chart.data.datasets = datasets;
            chart.update();
        }

        // Event Listeners
        document.querySelectorAll('input, select').forEach(el => el.addEventListener('change', updateChart));
        document.getElementById('solarSize').addEventListener('input', () => {
            document.getElementById('solarSizeValue').textContent = document.getElementById('solarSize').value;
            updateChart();
        });
        document.getElementById('battery').addEventListener('change', () => {
            document.getElementById('batteryOptions').classList.toggle('d-none', !document.getElementById('battery').checked);
            updateChart();
        });
        document.getElementById('compensation').addEventListener('change', () => {
            const buybackRateGroup = document.getElementById('buybackRateGroup');
            buybackRateGroup.classList.toggle('d-none', document.getElementById('compensation').value !== 'buyback');
            if (document.getElementById('compensation').value === 'buyback') {
                document.getElementById('buybackRate').value = (parseFloat(document.getElementById('rate').value) * 0.5).toFixed(4);
            }
        });

        // Load Distribution Checkbox Logic
        document.querySelectorAll('.load-dist').forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                if (checkbox.checked) {
                    // Uncheck all other checkboxes
                    document.querySelectorAll('.load-dist').forEach(cb => {
                        if (cb !== checkbox) cb.checked = false;
                    });
                    updateChart();
                } else {
                    // Ensure at least one is checked (default to Flat)
                    if (!document.querySelector('.load-dist:checked')) {
                        document.getElementById('loadFlat').checked = true;
                    }
                    updateChart();
                }
            });
        });

        // Initial Setup
        document.getElementById('month').value = new Date().getMonth() + 1;
        document.getElementById('solarSizeValue').textContent = document.getElementById('solarSize').value;
        document.getElementById('buybackRate').value = (0.145 * 0.5).toFixed(4);
        document.getElementById('buybackRateGroup').classList.add('d-none');
        document.getElementById('batteryOptions').classList.add('d-none');
        updateChart();
    </script>
</body>
</html>
