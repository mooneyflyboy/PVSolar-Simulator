<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PV Solar Simulator - DFW Metroplex</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f4f8;
            color: #333;
        }
        .header {
            background: linear-gradient(135deg, #007BFF, #00C4B4);
            color: white;
            text-align: center;
            padding: 2rem;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        .header p {
            font-size: 1rem;
        }
        .mobile-orientation {
            display: none;
            font-style: italic;
            font-size: 0.9rem;
            margin-top: 0.5rem;
            color: white;
            background-color: black;
            padding: 0.5rem;
            border-radius: 5px;
        }
        .container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 1.5rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .input-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        .form-group label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #555;
        }
        .form-group input[type="number"], .form-group select {
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        .form-group input[type="number"]:focus, .form-group select:focus {
            border-color: #007BFF;
            outline: none;
        }
        .form-group input[type="range"] {
            width: 100%;
            margin: 0.5rem 0;
        }
        .slider-value {
            font-size: 0.9rem;
            color: #007BFF;
        }
        #battery-size-div, #buyback-rate-div {
            margin-top: 0.5rem;
            padding-left: 1rem;
            display: none;
        }
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 0.5rem;
        }
        .toggle {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 34px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: #00C4B4;
        }
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        .toggle-label {
            font-size: 1rem;
            color: #555;
        }
        .results-section {
            padding: 1.5rem;
            background: #f9f9f9;
            border-radius: 10px;
        }
        .results-section h2 {
            font-size: 1.8rem;
            color: #007BFF;
            margin-bottom: 1rem;
        }
        .savings-cards {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }
        .savings-card {
            flex: 1;
            background: linear-gradient(135deg, #00C4B4, #007BFF);
            color: white;
            padding: 1.5rem;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .savings-card h3 {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }
        .savings-card p {
            font-size: 1.5rem;
            font-weight: 600;
        }
        #excess-statement {
            font-size: 0.9rem;
            color: #555;
            text-align: center;
            margin-bottom: 0.5rem;
            display: none;
        }
        #payback-period {
            font-size: 1rem;
            color: #333;
            text-align: center;
            margin-bottom: 0.5rem;
        }
        #payback-note {
            font-size: 0.8rem;
            color: #555;
            text-align: center;
            margin-bottom: 1.5rem;
        }
        #energy-chart {
            background: white;
            padding: 1rem;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .summary-container {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }
        #monthly-summary, #environmental-impact {
            flex: 1;
            min-width: 300px;
            padding: 1rem;
            border-radius: 10px;
        }
        #monthly-summary {
            background: #e6f0fa;
        }
        #environmental-impact {
            background: #e6f7e6;
        }
        #monthly-summary h3, #environmental-impact h3 {
            font-size: 1.4rem;
            color: #007BFF;
            margin-bottom: 1rem;
        }
        #monthly-summary ul, #environmental-impact ul {
            list-style: none;
        }
        #monthly-summary li, #environmental-impact li {
            font-size: 1rem;
            margin-bottom: 0.5rem;
            color: #333;
        }
        #monthly-summary li::before, #environmental-impact li::before {
            content: "✓ ";
            color: #00C4B4;
            font-weight: bold;
        }
        .disclaimer {
            margin-top: 1.5rem;
            padding: 1rem;
            background: #fff3cd;
            border-radius: 10px;
            font-size: 0.9rem;
            color: #856404;
        }
        .footer {
            text-align: center;
            padding: 1rem;
            background: #333;
            color: white;
            margin-top: 2rem;
            border-radius: 10px 10px 0 0;
        }
        @media (max-width: 600px) {
            .input-section {
                grid-template-columns: 1fr;
            }
            .savings-cards {
                flex-direction: column;
            }
            .summary-container {
                flex-direction: column;
            }
            .header h1 {
                font-size: 2rem;
            }
            .mobile-orientation {
                display: block;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Discover Your Solar Savings</h1>
        <p>Explore how solar power can reduce your energy costs in the DFW Metroplex</p>
        <p class="mobile-orientation">For best viewing on mobile, please hold your device horizontally.</p>
    </div>
    <div class="container">
        <div class="input-section">
            <div class="form-group">
                <label for="pv-size">PV Solar Size (kW)</label>
                <input type="range" id="pv-size" name="pv-size" min="5" max="40" step="0.2" value="10">
                <span class="slider-value" id="pv-size-value">10 kW</span>
            </div>
            <div class="form-group">
                <label for="monthly-bill">Monthly Utility Bill ($)</label>
                <input type="number" id="monthly-bill" name="monthly-bill" min="0" step="1" value="250" required>
            </div>
            <div class="form-group">
                <label for="price-per-kwh">Price per kWh ($)</label>
                <input type="number" id="price-per-kwh" name="price-per-kwh" min="0" step="0.01" value="0.145" required>
            </div>
            <div class="form-group">
                <label for="usage-pattern">Energy Usage Pattern</label>
                <select id="usage-pattern" name="usage-pattern">
                    <option value="flat">Flat</option>
                    <option value="morning_peak">Morning Peak</option>
                    <option value="evening_peak">Evening Peak</option>
                    <option value="work_from_home">Work from Home</option>
                </select>
            </div>
            <div class="form-group">
                <label for="excess-handling">Excess Energy Handling</label>
                <select id="excess-handling" name="excess-handling">
                    <option value="net_metering" selected>Net Metering</option>
                    <option value="buyback">Buyback at Specific Rate</option>
                    <option value="no_credit">No Credit</option>
                </select>
                <div id="buyback-rate-div">
                    <label for="buyback-rate">Buyback Rate ($/kWh)</label>
                    <input type="number" id="buyback-rate" name="buyback-rate" min="0" step="0.01" value="0.0725">
                </div>
            </div>
            <div class="form-group">
                <label for="month">Select Month</label>
                <select id="month" name="month">
                    <option value="0">January</option>
                    <option value="1">February</option>
                    <option value="2">March</option>
                    <option value="3">April</option>
                    <option value="4">May</option>
                    <option value="5">June</option>
                    <option value="6">July</option>
                    <option value="7">August</option>
                    <option value="8">September</option>
                    <option value="9">October</option>
                    <option value="10">November</option>
                    <option value="11">December</option>
                </select>
            </div>
            <div class="form-group">
                <label for="battery">Battery Storage</label>
                <div class="toggle-container">
                    <label class="toggle">
                        <input type="checkbox" id="battery" name="battery">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="toggle-label" id="battery-label">No</span>
                </div>
                <div id="battery-size-div">
                    <label for="battery-size">Battery Size (kWh)</label>
                    <input type="number" id="battery-size" name="battery-size" min="0" step="0.1" value="10">
                </div>
            </div>
        </div>

        <div class="results-section">
            <h2>Your Solar Savings</h2>
            <div class="savings-cards">
                <div class="savings-card">
                    <h3>First Year Savings</h3>
                    <p id="first-year-savings">-</p>
                </div>
                <div class="savings-card">
                    <h3>25-Year Savings</h3>
                    <p id="25-year-savings">-</p>
                </div>
            </div>
            <p id="excess-statement">Savings results include income from Net Metering option selected when appropriate.</p>
            <p id="payback-period">Estimated Payback Period: -</p>
            <p id="payback-note">Based on Net Cost including the 30% Federal Investment Tax Credit</p>
            <canvas id="energy-chart"></canvas>
            <div class="summary-container">
                <div id="monthly-summary"></div>
                <div id="environmental-impact"></div>
            </div>
            <div class="disclaimer">
                <p><strong>Disclaimer:</strong> This tool is for estimation purposes only. Actual solar performance may vary based on factors such as weather conditions, panel orientation, shading, system efficiency, and maintenance. Savings and excess energy compensation depend on your specific setup and Retail Electric Provider (REP) policies. Please verify compensation details for solar energy generated with your REP.</p>
            </div>
        </div>
    </div>
    <div class="footer">
        <p>Powered by Eco-NRGY Solutions © 2025</p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Monthly average daily solar production per kW in DFW (kWh/day), adjusted for higher production
        const monthly_solar_factors = [4.2, 4.5, 4.8, 5.0, 5.2, 5.4, 5.4, 5.2, 5.0, 4.8, 4.5, 4.2];
        // Average ~4.8 kWh/day/kW, leading to ~15,000 kWh/year for a 10 kW system

        // Generate hourly solar profiles (sine curve from 6 AM to 6 PM, scaled to daily total)
        function generateSolarProfile(factor) {
            const profile = Array(24).fill(0);
            for (let h = 6; h < 18; h++) {
                profile[h] = Math.sin((h - 6) / 12 * Math.PI);
            }
            const sum = profile.reduce((a, b) => a + b, 0);
            return profile.map(x => x * factor / sum);
        }

        const solar_profiles = monthly_solar_factors.map(factor => generateSolarProfile(factor));

        // Usage patterns (hourly fractions summing to 1)
        const usage_patterns = {
            flat: Array(24).fill(1/24),
            morning_peak: (() => {
                const p = Array(24).fill(0.02);
                for (let h = 6; h < 10; h++) p[h] = 0.08;
                const sum = p.reduce((a, b) => a + b, 0);
                return p.map(x => x / sum);
            })(),
            evening_peak: (() => {
                const p = Array(24).fill(0.02);
                for (let h = 17; h < 21; h++) p[h] = 0.08;
                const sum = p.reduce((a, b) => a + b, 0);
                return p.map(x => x / sum);
            })(),
            work_from_home: (() => {
                const p = Array(24).fill(0.02);
                for (let h = 8; h < 17; h++) p[h] = 0.06;
                const sum = p.reduce((a, b) => a + b, 0);
                return p.map(x => x / sum);
            })()
        };

        const days_in_month = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
        const month_names = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

        // Simulate one day's energy flow
        function simulateDay(solar_hourly, consumption_hourly, has_battery, battery_size) {
            let energy_drawn = 0;
            let energy_fed = 0;
            let soc = 0;
            let hourly_data = [];
            let total_solar = 0;
            let total_battery = 0;

            for (let h = 0; h < 24; h++) {
                let solar_available = solar_hourly[h];
                let consumption = consumption_hourly[h];
                let energy_from_solar = 0;
                let energy_from_battery = 0;
                let energy_from_grid = 0;

                total_solar += solar_available; // Count all solar production

                if (solar_available > 0) {
                    energy_from_solar = Math.min(solar_available, consumption);
                }

                let remaining_consumption = consumption - energy_from_solar;

                if (has_battery && remaining_consumption > 0) {
                    energy_from_battery = Math.min(remaining_consumption, soc);
                    soc -= energy_from_battery;
                    total_battery += energy_from_battery;
                    remaining_consumption -= energy_from_battery;
                }

                if (remaining_consumption > 0) {
                    energy_from_grid = remaining_consumption;
                    energy_drawn += energy_from_grid;
                }

                let excess_solar = solar_available - energy_from_solar;
                if (has_battery && excess_solar > 0) {
                    let charge = Math.min(excess_solar, battery_size - soc);
                    soc += charge;
                    excess_solar -= charge;
                }
                if (excess_solar > 0) {
                    energy_fed += excess_solar;
                }

                hourly_data.push({
                    energy_from_solar,
                    energy_from_battery,
                    energy_from_grid
                });
            }

            return {
                energy_drawn,
                energy_fed,
                hourly_data,
                total_solar,
                total_battery
            };
        }

        // Update slider value display
        const pvSizeSlider = document.getElementById('pv-size');
        const pvSizeValue = document.getElementById('pv-size-value');
        pvSizeSlider.addEventListener('input', () => {
            pvSizeValue.textContent = `${pvSizeSlider.value} kW`;
            calculateSavings();
        });

        // Battery toggle logic
        const batteryToggle = document.getElementById('battery');
        const batteryLabel = document.getElementById('battery-label');
        const batterySizeDiv = document.getElementById('battery-size-div');
        batteryToggle.addEventListener('change', () => {
            batterySizeDiv.style.display = batteryToggle.checked ? 'block' : 'none';
            batteryLabel.textContent = batteryToggle.checked ? 'Yes' : 'No';
            calculateSavings();
        });

        // Excess handling logic
        const excessHandlingSelect = document.getElementById('excess-handling');
        const buybackRateDiv = document.getElementById('buyback-rate-div');
        excessHandlingSelect.addEventListener('change', function() {
            buybackRateDiv.style.display = this.value === 'buyback' ? 'block' : 'none';
            calculateSavings();
        });

        // Add event listeners to all inputs for real-time updates
        const inputs = document.querySelectorAll('input, select');
        inputs.forEach(input => {
            input.addEventListener('input', calculateSavings);
            input.addEventListener('change', calculateSavings);
        });

        let chart;

        // Retrieve form data
        function getFormData() {
            try {
                return {
                    pv_size: parseFloat(document.getElementById('pv-size').value) || 0,
                    has_battery: document.getElementById('battery').checked,
                    battery_size: parseFloat(document.getElementById('battery-size').value) || 0,
                    monthly_bill: parseFloat(document.getElementById('monthly-bill').value) || 0,
                    price_per_kwh: parseFloat(document.getElementById('price-per-kwh').value) || 0,
                    usage_pattern: document.getElementById('usage-pattern').value,
                    excess_handling: document.getElementById('excess-handling').value,
                    buyback_rate: parseFloat(document.getElementById('buyback-rate').value) || 0,
                    selected_month: parseInt(document.getElementById('month').value)
                };
            } catch (error) {
                console.error('Error retrieving form data:', error);
                return null;
            }
        }

        function calculateSavings() {
            const formData = getFormData();
            if (!formData) {
                alert('Error reading form data.');
                return;
            }

            const { pv_size, has_battery, battery_size, monthly_bill, price_per_kwh, usage_pattern, excess_handling, buyback_rate, selected_month } = formData;

            if (!pv_size || !monthly_bill || !price_per_kwh) {
                document.getElementById('first-year-savings').textContent = '-';
                document.getElementById('25-year-savings').textContent = '-';
                document.getElementById('excess-statement').style.display = 'none';
                document.getElementById('payback-period').textContent = 'Estimated Payback Period: -';
                document.getElementById('monthly-summary').innerHTML = '';
                document.getElementById('environmental-impact').innerHTML = '';
                if (chart) chart.destroy();
                return;
            }
            if (has_battery && (!battery_size || battery_size <= 0)) {
                alert('Please specify a valid battery size.');
                return;
            }
            if (excess_handling === 'buyback' && (!buyback_rate || buyback_rate <= 0)) {
                alert('Please specify a valid buyback rate.');
                return;
            }

            try {
                const daily_consumption = (monthly_bill / price_per_kwh) / (365 / 12);
                let annual_cost_with_solar = 0;
                let annual_excess_energy = 0;
                let annual_solar_production = 0;
                let annual_battery_production = 0;

                for (let m = 0; m < 12; m++) {
                    const solar_hourly = solar_profiles[m].map(x => x * pv_size);
                    const consumption_hourly = usage_patterns[usage_pattern].map(x => x * daily_consumption);
                    const { energy_drawn, energy_fed, total_solar, total_battery } = simulateDay(solar_hourly, consumption_hourly, has_battery, battery_size);
                    const total_energy_drawn = energy_drawn * days_in_month[m];
                    const total_energy_fed = energy_fed * days_in_month[m];
                    let monthly_bill_with_solar;

                    if (excess_handling === 'net_metering' || excess_handling === 'buyback') {
                        annual_excess_energy += total_energy_fed;
                    }

                    annual_solar_production += total_solar * days_in_month[m];
                    annual_battery_production += total_battery * days_in_month[m];

                    switch (excess_handling) {
                        case 'net_metering':
                            monthly_bill_with_solar = Math.max(0, total_energy_drawn - total_energy_fed) * price_per_kwh;
                            break;
                        case 'buyback':
                            monthly_bill_with_solar = total_energy_drawn * price_per_kwh - total_energy_fed * buyback_rate;
                            break;
                        case 'no_credit':
                            monthly_bill_with_solar = total_energy_drawn * price_per_kwh;
                            break;
                    }

                    annual_cost_with_solar += monthly_bill_with_solar;
                }

                const annual_bill_without_solar = 12 * monthly_bill;
                let first_year_savings = annual_bill_without_solar - annual_cost_with_solar;

                // Add potential income from excess energy to first-year savings
                let excess_value = 0;
                if (excess_handling === 'net_metering') {
                    excess_value = annual_excess_energy * price_per_kwh;
                } else if (excess_handling === 'buyback') {
                    excess_value = annual_excess_energy * buyback_rate;
                }
                first_year_savings += excess_value;

                // Calculate 25-year savings with 3.5% escalation, including excess income
                let total_savings_25 = 0;
                for (let year = 1; year <= 25; year++) {
                    const escalation_factor = Math.pow(1 + 0.035, year - 1);
                    const escalated_bill_without_solar = annual_bill_without_solar * escalation_factor;
                    const escalated_cost_with_solar = annual_cost_with_solar * escalation_factor;
                    const escalated_excess_value = excess_value * escalation_factor;
                    const annual_savings = (escalated_bill_without_solar - escalated_cost_with_solar) + escalated_excess_value;
                    total_savings_25 += annual_savings;
                }

                // Calculate net system cost (not displayed)
                const pv_cost = pv_size * 2700; // $2.70/W = $2700/kW
                const battery_cost = has_battery ? battery_size * 1300 : 0; // $1300/kWh
                const total_cost = pv_cost + battery_cost;
                const net_cost = total_cost * 0.7; // Apply 30% ITC

                // Calculate payback period
                let payback_text = 'Estimated Payback Period: -';
                if (first_year_savings > 0) {
                    const payback_years = net_cost / first_year_savings;
                    const years = Math.floor(payback_years);
                    const months = Math.round((payback_years - years) * 12);
                    payback_text = `Estimated Payback Period: ${years} Year${years !== 1 ? 's' : ''}${months > 0 ? `, ${months} Month${months !== 1 ? 's' : ''}` : ''}`;
                }

                // Update UI
                document.getElementById('first-year-savings').textContent = `$${first_year_savings.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                document.getElementById('25-year-savings').textContent = `$${total_savings_25.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                document.getElementById('payback-period').textContent = payback_text;

                // Display excess statement if applicable
                if ((excess_handling === 'net_metering' || excess_handling === 'buyback') && annual_excess_energy > 0) {
                    const option_text = excess_handling === 'net_metering' ? 'Net Metering' : 'Buyback';
                    document.getElementById('excess-statement').style.display = 'block';
                    document.getElementById('excess-statement').textContent = `Savings results include income from ${option_text} option selected when appropriate.`;
                } else {
                    document.getElementById('excess-statement').style.display = 'none';
                }

                updateChart(annual_solar_production, annual_battery_production, selected_month);
            } catch (error) {
                console.error('Error in calculateSavings:', error);
                alert('An error occurred during calculation. Check console for details.');
            }
        }

        function updateChart(annual_solar_production, annual_battery_production, selected_month) {
            const formData = getFormData();
            if (!formData) {
                console.error('No form data available for chart update');
                return;
            }

            const { pv_size, has_battery, battery_size, monthly_bill, price_per_kwh, usage_pattern } = formData;
            try {
                const daily_consumption = (monthly_bill / price_per_kwh) / (365 / 12);
                const solar_hourly = solar_profiles[selected_month].map(x => x * pv_size);
                const consumption_hourly = usage_patterns[usage_pattern].map(x => x * daily_consumption);
                const { hourly_data, total_solar, total_battery } = simulateDay(solar_hourly, consumption_hourly, has_battery, battery_size);
                const labels = Array.from({length: 24}, (_, i) => `${i}:00`);
                const energy_from_solar = hourly_data.map(d => d.energy_from_solar);
                const energy_from_battery = hourly_data.map(d => d.energy_from_battery);
                const energy_from_grid = hourly_data.map(d => d.energy_from_grid);

                const total_grid_energy = energy_from_grid.reduce((sum, val) => sum + val, 0) * days_in_month[selected_month];
                const total_solar_energy = total_solar * days_in_month[selected_month];
                const total_battery_energy = total_battery * days_in_month[selected_month];
                const total_consumption = daily_consumption * days_in_month[selected_month];
                const grid_reduction_percent = ((total_consumption - total_grid_energy) / total_consumption * 100).toFixed(2);

                document.getElementById('monthly-summary').innerHTML = `
                    <h3>Summary for ${month_names[selected_month]}</h3>
                    <ul>
                        <li>Total Energy from Grid: ${total_grid_energy.toFixed(2)} kWh</li>
                        <li>Grid Reliance Reduction: ${grid_reduction_percent}%</li>
                        <li>Total Solar Production: ${total_solar_energy.toFixed(2)} kWh</li>
                        <li>Total Battery Production: ${total_battery_energy.toFixed(2)} kWh</li>
                    </ul>
                `;

                // Calculate environmental impact over 25 years
                const total_energy_25_years = (annual_solar_production + annual_battery_production) * 25; // kWh over 25 years
                const co2_emission_factor = 0.90; // lbs CO2/kWh (adjusted for Texas grid mix)
                const co2_reduction = total_energy_25_years * co2_emission_factor; // lbs CO2 avoided
                const co2_per_tree = 48; // lbs CO2 per tree (1-year equivalence, matching cited programs)
                const equivalent_trees = co2_reduction / co2_per_tree;
                const co2_per_mile = 0.78; // lbs CO2 per mile for average gasoline car (EPA 2023)
                const equivalent_miles = co2_reduction / co2_per_mile;

                document.getElementById('environmental-impact').innerHTML = `
                    <h3>Environmental Impact - 25Yrs</h3>
                    <ul>
                        <li>CO2 Reduction: ${co2_reduction.toLocaleString('en-US', { maximumFractionDigits: 0 })} lbs</li>
                        <li>Equivalent Trees Planted: ${equivalent_trees.toLocaleString('en-US', { maximumFractionDigits: 0 })}</li>
                        <li>Equivalent Miles Driven: ${equivalent_miles.toLocaleString('en-US', { maximumFractionDigits: 0 })}</li>
                    </ul>
                `;

                if (chart) {
                    chart.destroy();
                }

                chart = new Chart(document.getElementById('energy-chart'), {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'From Solar',
                                data: energy_from_solar,
                                borderColor: 'orange', // #FFA500
                                backgroundColor: '#FFB84D70', // Light orange
                                fill: true,
                                tension: 0.4
                            },
                            {
                                label: 'From Battery',
                                data: energy_from_battery,
                                borderColor: 'green', // #008000
                                backgroundColor: '#4CAF5070', // Light green
                                fill: true,
                                tension: 0.4
                            },
                            {
                                label: 'From Grid',
                                data: energy_from_grid,
                                borderColor: 'blue', // #0000FF
                                backgroundColor: '#6666FF70', // Light blue
                                fill: true,
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Daily Energy Source Breakdown',
                                color: '#007BFF',
                                font: {
                                    size: 16,
                                    family: 'Poppins',
                                    weight: '600'
                                },
                                padding: {
                                    top: 10,
                                    bottom: 20
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            },
                            legend: {
                                labels: {
                                    font: { size: 12 },
                                    color: '#333'
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Energy (kWh)', font: { size: 14 } }
                            },
                            x: {
                                title: { display: true, text: 'Hour of Day', font: { size: 14 } }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error in updateChart:', error);
                alert('An error occurred while updating the chart. Check console for details.');
            }
        }

        // Set default month to current month and calculate initial results
        try {
            document.getElementById('month').value = new Date().getMonth();
            pvSizeValue.textContent = `${pvSizeSlider.value} kW`;
            buybackRateDiv.style.display = 'none'; // Ensure buyback rate is hidden initially
            batterySizeDiv.style.display = 'none'; // Ensure battery size is hidden initially
            calculateSavings();
        } catch (error) {
            console.error('Error during initial setup:', error);
        }
    </script>
</body>
</html>
